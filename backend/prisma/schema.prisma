// TradeNexus AI - Prisma Schema
// 版本: v3.0
// 数据库: PostgreSQL + pgvector

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  // extensions = [pgvector(map: "vector")]  // 需要先安装 pgvector 扩展
}

// ============================================
// 用户模块
// ============================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String?
  role         String   @default("user") // 'admin', 'user'
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  products   Product[]
  jobs       Job[]
  apiConfigs UserApiConfig[]

  @@map("users")
}

// 用户 API 配置 (存储个人 API Key)
model UserApiConfig {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  keyName   String   @map("key_name") // 'GEMINI_API_KEY', 'APIFY_TOKEN'
  keyValue  String   @map("key_value") // 加密存储
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, keyName])
  @@map("user_api_configs")
}

// ============================================
// 产品模块 (选品数据)
// ============================================

model Product {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  platform    String   // 'amazon', 'tiktok', 'shopee', 'lazada'
  platformId  String   @map("platform_id") // ASIN 或 Product ID
  title       String
  imageUrl    String?  @map("image_url")
  sellPrice   Decimal? @map("sell_price") @db.Decimal(10, 2)
  currency    String   @default("USD")
  category    String?
  bsrRank     Int?     @map("bsr_rank")
  reviewCount Int?     @map("review_count")
  rating      Decimal? @db.Decimal(3, 2)
  status      String   @default("new") // 'new', 'analyzed', 'sourced', 'archived'
  aiAnalysis  Json?    @map("ai_analysis") // AI 分析结果 JSON
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourcingResults    SourcingResult[]
  profitCalculations ProfitCalculation[]
  complianceChecks   ComplianceCheck[]

  @@unique([platform, platformId])
  @@index([userId])
  @@index([status])
  @@map("products")
}

// ============================================
// 供应链模块 (1688 货源)
// ============================================

model SourcingResult {
  id             String   @id @default(uuid())
  productId      String   @map("product_id")
  supplierUrl    String   @map("supplier_url")
  supplierName   String?  @map("supplier_name")
  costPrice      Decimal  @map("cost_price") @db.Decimal(10, 2)
  currency       String   @default("CNY")
  moq            Int? // 最小起订量
  supplierRating Decimal? @map("supplier_rating") @db.Decimal(3, 2)
  shopYears      Int?     @map("shop_years") // 开店年限
  matchScore     Decimal? @map("match_score") @db.Decimal(3, 2) // AI 匹配度
  imageUrl       String?  @map("image_url")
  createdAt      DateTime @default(now()) @map("created_at")

  // 关联
  product            Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  profitCalculations ProfitCalculation[]

  @@index([productId])
  @@map("sourcing_results")
}

// ============================================
// 利润计算模块
// ============================================

model ProfitCalculation {
  id            String   @id @default(uuid())
  productId     String   @map("product_id")
  sourcingId    String?  @map("sourcing_id")
  sellPrice     Decimal  @map("sell_price") @db.Decimal(10, 2)
  costPrice     Decimal  @map("cost_price") @db.Decimal(10, 2)
  shippingCost  Decimal  @map("shipping_cost") @db.Decimal(10, 2)
  platformFee   Decimal  @map("platform_fee") @db.Decimal(10, 2)
  fbaFee        Decimal  @map("fba_fee") @db.Decimal(10, 2)
  marketingCost Decimal  @map("marketing_cost") @db.Decimal(10, 2)
  netProfit     Decimal  @map("net_profit") @db.Decimal(10, 2)
  profitMargin  Decimal  @map("profit_margin") @db.Decimal(5, 2) // 百分比
  exchangeRate  Decimal  @map("exchange_rate") @db.Decimal(6, 4)
  createdAt     DateTime @default(now()) @map("created_at")

  // 关联
  product  Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  sourcing SourcingResult? @relation(fields: [sourcingId], references: [id])

  @@index([productId])
  @@map("profit_calculations")
}

// ============================================
// 合规检查模块
// ============================================

model ComplianceCheck {
  id                    String   @id @default(uuid())
  productId             String   @map("product_id")
  market                String // 'US', 'EU', 'SEA', 'AU'
  hsCode                String?  @map("hs_code")
  taxRate               Decimal? @map("tax_rate") @db.Decimal(5, 2)
  certificationsRequired String[] @map("certifications_required") // ['FDA', 'CE', 'CPC']
  riskLevel             String   @map("risk_level") // 'low', 'medium', 'high'
  aiNotes               String?  @map("ai_notes")
  createdAt             DateTime @default(now()) @map("created_at")

  // 关联
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("compliance_checks")
}

// ============================================
// 任务队列模块
// ============================================

model Job {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  type         String // 'AMAZON_SEARCH', '1688_FIND', 'PROFIT_CALC', 'COMPLIANCE_CHECK'
  status       String    @default("pending") // 'pending', 'running', 'completed', 'failed'
  inputData    Json?     @map("input_data")
  outputData   Json?     @map("output_data")
  errorMessage String?   @map("error_message")
  progress     Int       @default(0) // 0-100
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("jobs")
}

// ============================================
// RAG 知识库 (向量存储)
// ============================================

model KnowledgeEmbedding {
  id        String                       @id @default(uuid())
  category  String // 'hs_code', 'regulation', 'certification'
  title     String
  content   String
  embedding Unsupported("vector(1536)")? // OpenAI embedding 维度
  metadata  Json?
  createdAt DateTime                     @default(now()) @map("created_at")

  @@index([category])
  @@map("knowledge_embeddings")
}

// ============================================
// 供应商收藏
// ============================================

model Supplier {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  platform     String   @default("1688") // '1688', 'alibaba'
  supplierUrl  String   @map("supplier_url")
  supplierName String   @map("supplier_name")
  contactInfo  Json?    @map("contact_info") // { wechat, phone, qq }
  rating       Decimal? @db.Decimal(3, 2)
  notes        String?
  tags         String[] // ['reliable', 'fast-shipping', 'good-quality']
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("suppliers")
}
