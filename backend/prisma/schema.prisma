// TradeNexus AI - Prisma Schema
// 版本: v3.0
// 数据库: PostgreSQL + pgvector

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  // extensions = [pgvector(map: "vector")]  // 需要先安装 pgvector 扩展
}

// ============================================
// 用户模块
// ============================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String?
  role         String   @default("user") // 'admin', 'user'
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  products   Product[]
  jobs       Job[]
  apiConfigs UserApiConfig[]

  @@map("users")
}

// 用户 API 配置 (存储个人 API Key)
model UserApiConfig {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  keyName   String   @map("key_name") // 'GEMINI_API_KEY', 'APIFY_TOKEN'
  keyValue  String   @map("key_value") // 加密存储
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, keyName])
  @@map("user_api_configs")
}

// ============================================
// 产品模块 (选品数据)
// ============================================

model Product {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  platform    String   // 'amazon', 'tiktok', 'shopee', 'lazada'
  platformId  String   @map("platform_id") // ASIN 或 Product ID
  title       String
  imageUrl    String?  @map("image_url")
  sellPrice   Decimal? @map("sell_price") @db.Decimal(10, 2)
  currency    String   @default("USD")
  category    String?
  bsrRank     Int?     @map("bsr_rank")
  reviewCount Int?     @map("review_count")
  rating      Decimal? @db.Decimal(3, 2)
  status      String   @default("new") // 'new', 'analyzed', 'sourced', 'archived'
  aiAnalysis  Json?    @map("ai_analysis") // AI 分析结果 JSON
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourcingResults    SourcingResult[]
  profitCalculations ProfitCalculation[]
  complianceChecks   ComplianceCheck[]

  @@unique([platform, platformId])
  @@index([userId])
  @@index([status])
  @@map("products")
}

// ============================================
// 供应链模块 (1688 货源)
// ============================================

model SourcingResult {
  id             String   @id @default(uuid())
  productId      String   @map("product_id")
  supplierUrl    String   @map("supplier_url")
  supplierName   String?  @map("supplier_name")
  costPrice      Decimal  @map("cost_price") @db.Decimal(10, 2)
  currency       String   @default("CNY")
  moq            Int? // 最小起订量
  supplierRating Decimal? @map("supplier_rating") @db.Decimal(3, 2)
  shopYears      Int?     @map("shop_years") // 开店年限
  matchScore     Decimal? @map("match_score") @db.Decimal(3, 2) // AI 匹配度
  imageUrl       String?  @map("image_url")
  createdAt      DateTime @default(now()) @map("created_at")

  // 关联
  product            Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  profitCalculations ProfitCalculation[]

  @@index([productId])
  @@map("sourcing_results")
}

// ============================================
// 利润计算模块
// ============================================

model ProfitCalculation {
  id            String   @id @default(uuid())
  productId     String   @map("product_id")
  sourcingId    String?  @map("sourcing_id")
  sellPrice     Decimal  @map("sell_price") @db.Decimal(10, 2)
  costPrice     Decimal  @map("cost_price") @db.Decimal(10, 2)
  shippingCost  Decimal  @map("shipping_cost") @db.Decimal(10, 2)
  platformFee   Decimal  @map("platform_fee") @db.Decimal(10, 2)
  fbaFee        Decimal  @map("fba_fee") @db.Decimal(10, 2)
  marketingCost Decimal  @map("marketing_cost") @db.Decimal(10, 2)
  netProfit     Decimal  @map("net_profit") @db.Decimal(10, 2)
  profitMargin  Decimal  @map("profit_margin") @db.Decimal(5, 2) // 百分比
  exchangeRate  Decimal  @map("exchange_rate") @db.Decimal(6, 4)
  createdAt     DateTime @default(now()) @map("created_at")

  // 关联
  product  Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  sourcing SourcingResult? @relation(fields: [sourcingId], references: [id])

  @@index([productId])
  @@map("profit_calculations")
}

// ============================================
// 合规检查模块
// ============================================

model ComplianceCheck {
  id                    String   @id @default(uuid())
  productId             String   @map("product_id")
  market                String // 'US', 'EU', 'SEA', 'AU'
  hsCode                String?  @map("hs_code")
  taxRate               Decimal? @map("tax_rate") @db.Decimal(5, 2)
  certificationsRequired String[] @map("certifications_required") // ['FDA', 'CE', 'CPC']
  riskLevel             String   @map("risk_level") // 'low', 'medium', 'high'
  aiNotes               String?  @map("ai_notes")
  createdAt             DateTime @default(now()) @map("created_at")

  // 关联
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("compliance_checks")
}

// ============================================
// 任务队列模块
// ============================================

model Job {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  type         String // 'AMAZON_SEARCH', '1688_FIND', 'PROFIT_CALC', 'COMPLIANCE_CHECK'
  status       String    @default("pending") // 'pending', 'running', 'completed', 'failed'
  inputData    Json?     @map("input_data")
  outputData   Json?     @map("output_data")
  errorMessage String?   @map("error_message")
  progress     Int       @default(0) // 0-100
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("jobs")
}

// ============================================
// RAG 知识库 (向量存储)
// ============================================

model KnowledgeEmbedding {
  id        String                       @id @default(uuid())
  category  String // 'hs_code', 'regulation', 'certification'
  title     String
  content   String
  embedding Unsupported("vector(1536)")? // OpenAI embedding 维度
  metadata  Json?
  createdAt DateTime                     @default(now()) @map("created_at")

  @@index([category])
  @@map("knowledge_embeddings")
}

// ============================================
// 供应商收藏
// ============================================

model Supplier {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  platform     String   @default("1688") // '1688', 'alibaba'
  supplierUrl  String   @map("supplier_url")
  supplierName String   @map("supplier_name")
  contactInfo  Json?    @map("contact_info") // { wechat, phone, qq }
  rating       Decimal? @db.Decimal(3, 2)
  notes        String?
  tags         String[] // ['reliable', 'fast-shipping', 'good-quality']
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  capabilities SupplierCapability[]
  quotes       Quote[]

  @@index([userId])
  @@map("suppliers")
}

// ============================================
// Titans 长期记忆系统
// ============================================

// 时效性报价表 (事实记忆核心)
model Quote {
  id           String   @id @default(uuid())
  supplierId   String?  @map("supplier_id")
  itemType     String   @map("item_type")     // 'product', 'freight', 'service'
  itemName     String   @map("item_name")
  price        Decimal  @db.Decimal(10, 2)
  currency     String   @default("USD")
  unit         String?                         // 'per_kg', 'per_cbm', 'per_unit'
  route        String?                         // 'CN-DE', 'CN-US' (物流专用)
  terms        String?                         // 'FOB', 'CIF', 'EXW'
  validFrom    DateTime @default(now()) @map("valid_from")
  validUntil   DateTime @map("valid_until")    // TTL 过期时间
  isDeprecated Boolean  @default(false) @map("is_deprecated")
  source       String?                         // 'user_input', 'search_rag', 'api'
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  @@index([itemType, validUntil])
  @@index([route, validUntil])
  @@index([supplierId])
  @@map("quotes")
}

// 知识块表 (语义记忆 - 增强版)
model KnowledgeChunk {
  id           String                       @id @default(uuid())
  category     String                       // 'regulation', 'contract', 'product_spec', 'tariff'
  country      String?                      // 'US', 'DE', 'CN', 'EU'
  title        String
  content      String
  embedding    Unsupported("vector(1536)")?
  source       String?                      // 来源URL或文件名
  version      String?                      // '2024', '2025'
  isDeprecated Boolean  @default(false) @map("is_deprecated")
  supersededBy String?  @map("superseded_by") // 被哪个新版本替代
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([category, country])
  @@index([isDeprecated])
  @@map("knowledge_chunks")
}

// 对话记忆摘要表 (长期交互记忆)
model ConversationMemory {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  sessionId       String?  @map("session_id")
  summary         String                      // AI 生成的摘要
  keyEntities     Json     @map("key_entities")   // {"focus_country": "DE", "focus_product": "LED"}
  userPreferences Json?    @map("user_preferences") // {"prefers_sea_freight": true}
  actionItems     Json?    @map("action_items")   // 待办事项
  sentiment       String?                     // 'positive', 'neutral', 'negative'
  importance      Int      @default(5)        // 1-10 重要性评分
  lastInteraction DateTime @map("last_interaction")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([userId, lastInteraction])
  @@index([importance])
  @@map("conversation_memories")
}

// 实体关系表 (关联记忆 - 简化版图谱)
model EntityRelation {
  id           String   @id @default(uuid())
  fromType     String   @map("from_type")     // 'supplier', 'product', 'country', 'forwarder'
  fromId       String   @map("from_id")
  fromName     String   @map("from_name")
  relationType String   @map("relation_type") // 'produces', 'requires', 'serves', 'has_certification'
  toType       String   @map("to_type")
  toId         String   @map("to_id")
  toName       String   @map("to_name")
  properties   Json?                          // 关系属性
  confidence   Decimal? @db.Decimal(3, 2)     // AI 提取的置信度
  source       String?                        // 数据来源
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([fromType, fromId])
  @@index([toType, toId])
  @@index([relationType])
  @@map("entity_relations")
}

// 供应商能力表 (扩展 Supplier)
model SupplierCapability {
  id             String    @id @default(uuid())
  supplierId     String    @map("supplier_id")
  capability     String                       // 'dangerous_goods', 'cold_chain', 'oversized'
  certification  String?                      // 'ISO9001', 'IATF16949', 'UN38.3'
  validUntil     DateTime? @map("valid_until")
  verifiedAt     DateTime? @map("verified_at")
  verifiedSource String?   @map("verified_source")
  createdAt      DateTime  @default(now()) @map("created_at")

  // 关联
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId])
  @@index([capability])
  @@map("supplier_capabilities")
}
