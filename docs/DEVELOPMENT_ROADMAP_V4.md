# TradeNexus AI v4.0 开发路线图
## 融合 Titans 长期记忆系统的智能外贸平台

> **版本**: v4.0  
> **更新日期**: 2025-12-13  
> **核心升级**: 基于 Google Titans (MAC) 研究构建分层记忆架构

---

## 📋 目录

1. [版本演进概览](#1-版本演进概览)
2. [核心架构升级](#2-核心架构升级)
3. [功能模块规划](#3-功能模块规划)
4. [开发阶段路线图](#4-开发阶段路线图)
5. [技术实施细节](#5-技术实施细节)
6. [里程碑与验收标准](#6-里程碑与验收标准)

---

## 1. 版本演进概览

### 1.1 版本对比

| 维度 | v2.0 | v3.0 | v4.0 (当前) |
|------|------|------|-------------|
| **架构** | 纯前端 | 全栈 NestJS | 全栈 + Titans 记忆系统 |
| **AI 能力** | 通用 Prompt | RAG 知识库 | **Search-RAG + 长期记忆** |
| **数据持久化** | localStorage | PostgreSQL | PostgreSQL + pgvector + 图谱 |
| **实时信息** | ❌ | ❌ | ✅ Tavily + Function Calling |
| **记忆能力** | 无 | 会话级 | **三脑长期记忆** |

### 1.2 v4.0 核心创新

```
┌─────────────────────────────────────────────────────────────────────┐
│                    TradeNexus AI v4.0 智能架构                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐          │
│   │ Search-RAG  │     │   Titans    │     │  Multi-Agent│          │
│   │ 实时搜索    │ ──► │ 长期记忆    │ ──► │  协同系统   │          │
│   └─────────────┘     └─────────────┘     └─────────────┘          │
│         │                   │                   │                   │
│         ▼                   ▼                   ▼                   │
│   ┌─────────────────────────────────────────────────────┐          │
│   │              外贸业务闭环                            │          │
│   │  选品发现 → 货源匹配 → 合规检查 → 利润计算 → 客户开发│          │
│   └─────────────────────────────────────────────────────┘          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心架构升级

### 2.1 Titans 三脑记忆模型

基于 Google Titans (MAC - Memory as Context) 研究理念，构建外贸领域专用的分层记忆系统：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Titans 长期记忆系统                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │   事实记忆       │  │   语义记忆       │  │   关联记忆       │  │
│  │  Factual Memory  │  │  Semantic Memory │  │ Associative Memory│ │
│  ├──────────────────┤  ├──────────────────┤  ├──────────────────┤  │
│  │ • 报价数据 (TTL) │  │ • 法规文档       │  │ • 供应商→产品   │  │
│  │ • 汇率/运费      │  │ • 合同条款       │  │ • 产品→认证     │  │
│  │ • 供应商评级     │  │ • 产品说明       │  │ • 国家→货代     │  │
│  ├──────────────────┤  ├──────────────────┤  ├──────────────────┤  │
│  │   PostgreSQL     │  │    pgvector      │  │  EntityRelation  │  │
│  │   Quote 表       │  │ KnowledgeChunk表 │  │      表          │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    对话记忆 (Conversation Memory)             │  │
│  │         用户偏好 • 关注领域 • 历史交互摘要                    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 Search-RAG 实时搜索架构

```
用户问题: "杭州天气怎么样？" / "最新特斯拉股价？"
           │
           ▼
    ┌─────────────────┐
    │  Query Analyzer │ ← 分类: business / realtime / general
    └─────────────────┘
           │
    ┌──────┴──────┐
    ▼             ▼
┌────────┐   ┌────────────┐
│ 本地   │   │ Function   │
│ 知识库 │   │ Calling    │
└────────┘   └────────────┘
                  │
        ┌────────┴────────┐
        ▼                 ▼
   ┌─────────┐      ┌─────────┐
   │ Tavily  │      │ wttr.in │
   │ Search  │      │ Weather │
   └─────────┘      └─────────┘
        │                 │
        └────────┬────────┘
                 ▼
    ┌─────────────────────┐
    │   Memory Manager    │ ← 提取并保存有价值信息
    └─────────────────────┘
                 │
                 ▼
    ┌─────────────────────┐
    │   LLM 生成回答      │
    └─────────────────────┘
```

### 2.3 系统拓扑图 (v4.0)

```
┌─────────────────────────────────────────────────────────────────────┐
│                    TradeNexus Station v4.0                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   用户浏览器 ──HTTP:80──→ [Vite Dev / Nginx]                        │
│                              │                                      │
│                    ┌─────────┴─────────┐                            │
│                    ↓                   ↓                            │
│              [React 前端]        [Nest.js API]                       │
│              联网开关 UI              │                              │
│                              ┌───────┼───────┬───────┐              │
│                              ↓       ↓       ↓       ↓              │
│                         [AI Module] [Memory] [Amazon] [Jobs]        │
│                              │       Module   Module  Module        │
│                              │         │                            │
│                    ┌─────────┴─────────┴─────────┐                  │
│                    ↓         ↓         ↓         ↓                  │
│              [PostgreSQL] [pgvector] [Redis] [BullMQ]               │
│                    │                                                │
│         ┌─────────┼─────────┬─────────┐                            │
│         ↓         ↓         ↓         ↓                            │
│      [Quote]  [Knowledge] [Entity]  [Conversation]                  │
│       Table   Chunk Table Relation   Memory Table                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                               │
              ┌────────────────┼────────────────┐
              ↓                ↓                ↓
        [DeepSeek V3.1]   [Tavily AI]     [wttr.in]
         Function Call     Real-time       Weather
                           Search          API
```

---

## 3. 功能模块规划

### 3.1 模块依赖关系

```
                    ┌─────────────────┐
                    │   Phase 3       │
                    │   基础设施      │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        ▼                    ▼                    ▼
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│   Phase 3.5   │    │   Phase 4     │    │   Phase 5     │
│ Titans 记忆   │    │ 合规与多市场  │    │ CRM与自动化   │
└───────┬───────┘    └───────┬───────┘    └───────┬───────┘
        │                    │                    │
        └────────────────────┼────────────────────┘
                             ▼
                    ┌─────────────────┐
                    │   Phase 6       │
                    │   智能化增强    │
                    └─────────────────┘
```

### 3.2 功能模块清单

#### 模块 A: AI 智能体系统 ✅ 已实现

| 功能 | 描述 | 状态 | 优先级 |
|------|------|------|--------|
| DeepSeek V3.1 集成 | 主力 AI 模型 | ✅ 完成 | P0 |
| Function Calling | 工具调用能力 | ✅ 完成 | P0 |
| Search-RAG | Tavily 实时搜索 | ✅ 完成 | P0 |
| 天气查询 | wttr.in API | ✅ 完成 | P1 |
| 联网开关 | 用户控制联网模式 | ✅ 完成 | P1 |
| 模型切换 | 支持多模型选择 | ✅ 完成 | P1 |

#### 模块 B: Titans 长期记忆 🔄 进行中

| 功能 | 描述 | 状态 | 优先级 |
|------|------|------|--------|
| Quote 报价记忆 | 带 TTL 的价格存储 | ✅ Schema 完成 | P0 |
| KnowledgeChunk 知识库 | 法规/合同向量存储 | ✅ Schema 完成 | P0 |
| ConversationMemory | 对话摘要存储 | ✅ Schema 完成 | P0 |
| EntityRelation 图谱 | 实体关系存储 | ✅ Schema 完成 | P1 |
| Memory Manager Agent | 自动提取/保存记忆 | ✅ 工具定义完成 | P0 |
| 混合检索 | SQL + Vector + Graph | ✅ 代码完成 | P0 |
| pgvector 部署 | 向量索引 | ⬜ 待部署 | P0 |
| 记忆遗忘机制 | TTL 自动清理 | ✅ 代码完成 | P1 |

#### 模块 C: 外贸业务功能

| 功能 | 描述 | 状态 | 优先级 |
|------|------|------|--------|
| Amazon 数据 | RapidAPI 真实数据 | ✅ 完成 | P0 |
| 利润计算器 | 成本/利润分析 | ✅ 完成 | P0 |
| 供应链搜索 | 1688 货源匹配 | 🔄 Mock 完成 | P0 |
| 合规检查 | HS Code + 认证 | 🔄 框架完成 | P1 |
| 产品管理 | CRUD + 持久化 | 🔄 Mock 完成 | P1 |

---

## 4. 开发阶段路线图

### 4.1 总体时间线

```
Week 1-2    Week 3-4    Week 5-6    Week 7-8    Week 9-10   Week 11-12
   │           │           │           │           │           │
   ▼           ▼           ▼           ▼           ▼           ▼
┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐
│Phase │   │Phase │   │Phase │   │Phase │   │Phase │   │Phase │
│ 3.5a │   │ 3.5b │   │  4a  │   │  4b  │   │  5a  │   │  5b  │
│记忆  │   │记忆  │   │合规  │   │多市场│   │CRM   │   │自动化│
│基础  │   │集成  │   │系统  │   │支持  │   │基础  │   │增强  │
└──────┘   └──────┘   └──────┘   └──────┘   └──────┘   └──────┘
```

---

### Phase 3.5: Titans 记忆系统 (Week 1-4)

> **目标**: 构建外贸领域的长期记忆能力

#### Sprint 3.5a: 记忆基础设施 (Week 1-2)

| ID | 任务 | 描述 | 优先级 | 状态 |
|----|------|------|--------|------|
| 3.5.1 | PostgreSQL 部署 | 安装并配置数据库 | P0 | ⬜ |
| 3.5.2 | pgvector 安装 | 向量扩展部署 | P0 | ⬜ |
| 3.5.3 | Prisma 迁移 | 执行数据库迁移 | P0 | ⬜ |
| 3.5.4 | Quote CRUD | 报价增删改查 | P0 | ✅ |
| 3.5.5 | KnowledgeChunk CRUD | 知识库增删改查 | P0 | ✅ |
| 3.5.6 | ConversationMemory CRUD | 对话记忆增删改查 | P0 | ✅ |
| 3.5.7 | EntityRelation CRUD | 实体关系增删改查 | P1 | ✅ |
| 3.5.8 | TTL 清理任务 | 定时清理过期数据 | P1 | ✅ |

**验收标准**:
- [ ] `POST /memory/quote` 可保存报价，30天后自动过期
- [ ] `GET /memory/quotes?route=CN-DE` 返回有效报价
- [ ] `POST /memory/knowledge` 可保存法规知识
- [ ] `GET /memory/stats` 返回记忆统计

#### Sprint 3.5b: 记忆智能集成 (Week 3-4)

| ID | 任务 | 描述 | 优先级 | 状态 |
|----|------|------|--------|------|
| 3.5.9 | Memory Agent 集成 | 将记忆工具集成到 AI 服务 | P0 | ⬜ |
| 3.5.10 | 混合检索集成 | smartChat 调用 hybridSearch | P0 | ⬜ |
| 3.5.11 | 自动记忆提取 | 对话结束自动总结 | P1 | ⬜ |
| 3.5.12 | 向量嵌入服务 | 集成 Embedding API | P1 | ⬜ |
| 3.5.13 | 知识冲突检测 | 新旧知识版本管理 | P2 | ⬜ |
| 3.5.14 | 前端记忆面板 | 显示记忆状态 | P2 | ⬜ |

**验收标准**:
- [ ] AI 回答问题时自动查询长期记忆
- [ ] 用户询问报价时，优先返回记忆中的数据
- [ ] 对话结束时自动生成摘要并存储
- [ ] 搜索到新法规时自动更新知识库

---

### Phase 4: 合规与多市场 (Week 5-8)

> **目标**: 完善合规检查，扩展市场覆盖

#### Sprint 4a: 合规系统 (Week 5-6)

| ID | 任务 | 描述 | 优先级 | 状态 |
|----|------|------|--------|------|
| 4.1.1 | HS Code 知识库 | 导入 HS 编码数据 | P0 | ⬜ |
| 4.1.2 | 认证要求映射 | FDA/CE/CPC 规则 | P0 | ⬜ |
| 4.1.3 | 合规检查 API | 输入产品返回风险 | P0 | ⬜ |
| 4.1.4 | 关税计算 | 基于 HS Code | P1 | ⬜ |
| 4.1.5 | 合规报告生成 | PDF 导出 | P2 | ⬜ |

#### Sprint 4b: 多市场支持 (Week 7-8)

| ID | 任务 | 描述 | 优先级 | 状态 |
|----|------|------|--------|------|
| 4.2.1 | Shopee 数据源 | 东南亚市场 | P1 | ⬜ |
| 4.2.2 | Lazada 数据源 | 东南亚市场 | P2 | ⬜ |
| 4.2.3 | 多币种支持 | SGD/MYR/THB | P1 | ⬜ |
| 4.2.4 | 区域法规库 | 东南亚认证要求 | P1 | ⬜ |

---

### Phase 5: CRM与自动化 (Week 9-12)

> **目标**: 客户开发与业务自动化

#### Sprint 5a: CRM 基础 (Week 9-10)

| ID | 任务 | 描述 | 优先级 | 状态 |
|----|------|------|--------|------|
| 5.1.1 | 客户管理模块 | 客户信息存储 | P1 | ⬜ |
| 5.1.2 | 开发信生成 | AI 多语言邮件 | P0 | ⬜ |
| 5.1.3 | 供应商管理 | 收藏与评价 | P1 | ⬜ |
| 5.1.4 | 沟通记录 | 邮件/消息历史 | P2 | ⬜ |

#### Sprint 5b: 自动化增强 (Week 11-12)

| ID | 任务 | 描述 | 优先级 | 状态 |
|----|------|------|--------|------|
| 5.2.1 | 价格监控 | 定时检测变化 | P1 | ⬜ |
| 5.2.2 | 报告自动生成 | 周报/月报 | P2 | ⬜ |
| 5.2.3 | 提醒系统 | 报价过期提醒 | P1 | ⬜ |
| 5.2.4 | 批量操作 | 批量分析产品 | P2 | ⬜ |

---

## 5. 技术实施细节

### 5.1 数据库 Schema 总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PostgreSQL + pgvector                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【用户模块】              【产品模块】              【供应链模块】    │
│  ┌─────────┐              ┌─────────┐              ┌─────────────┐  │
│  │ users   │──1:N──────►  │products │──1:N──────► │sourcing_    │  │
│  └─────────┘              └─────────┘              │results      │  │
│       │                        │                   └─────────────┘  │
│       │                        │                                    │
│       │                   ┌────┴────┐                               │
│       │                   ▼         ▼                               │
│       │            ┌──────────┐ ┌────────────┐                      │
│       │            │profit_   │ │compliance_ │                      │
│       │            │calculations│ │checks      │                     │
│       │            └──────────┘ └────────────┘                      │
│       │                                                             │
│  【Titans 记忆模块】                                                 │
│  ┌─────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │   quotes    │  │ knowledge_chunks │  │ entity_relations│         │
│  │  (事实记忆) │  │   (语义记忆)     │  │   (关联记忆)    │         │
│  └─────────────┘  └─────────────────┘  └─────────────────┘         │
│         │                  │                                        │
│         └──────────────────┼──────────────────┐                     │
│                            ▼                  ▼                     │
│                   ┌─────────────────┐  ┌───────────────┐           │
│                   │conversation_    │  │supplier_      │           │
│                   │memories         │  │capabilities   │           │
│                   │  (对话记忆)     │  │  (供应商能力) │           │
│                   └─────────────────┘  └───────────────┘           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 API 端点规划

#### AI 模块 (`/ai`)
```
POST /ai/chat              # 智能对话 (支持联网模式)
GET  /ai/models            # 获取可用模型
GET  /ai/weather           # 天气查询
```

#### Memory 模块 (`/memory`) - 新增
```
POST /memory/quote         # 保存报价
GET  /memory/quotes        # 查询有效报价
POST /memory/quotes/prune  # 清理过期报价

POST /memory/knowledge     # 保存知识
GET  /memory/knowledge/search  # 搜索知识库

POST /memory/conversation  # 保存对话摘要
GET  /memory/conversation/:userId  # 获取用户记忆

POST /memory/relation      # 保存实体关系
GET  /memory/graph/traverse  # 图谱遍历

POST /memory/search/hybrid # 混合检索
GET  /memory/stats         # 记忆统计
```

#### 业务模块
```
GET  /amazon/search        # Amazon 产品搜索
GET  /amazon/product/:asin # 产品详情

POST /products             # 创建产品
GET  /products             # 产品列表
PUT  /products/:id         # 更新产品

POST /sourcing/search      # 供应链搜索
POST /sourcing/profit      # 利润计算

POST /compliance/check     # 合规检查
```

### 5.3 Memory Agent 工具集成

```typescript
// ai.service.ts 中集成 Memory Tools
const MEMORY_TOOLS = [
  { name: 'save_quote', description: '保存报价信息' },
  { name: 'save_regulation', description: '保存法规知识' },
  { name: 'save_relation', description: '保存实体关系' },
  { name: 'summarize_conversation', description: '总结对话' },
  { name: 'query_memory', description: '查询长期记忆' },
];

// smartChat 流程
async smartChat(query, history, modelKey, webSearchMode) {
  // 1. 查询长期记忆
  const memories = await memoryService.hybridSearch(query, context);
  
  // 2. 组装增强 Prompt
  const memoryContext = memoryService.assembleMemoryContext(memories);
  
  // 3. 调用 AI (带记忆上下文)
  const response = await callAI(query, memoryContext, tools);
  
  // 4. 处理工具调用 (保存新记忆)
  if (response.tool_calls) {
    await processMemoryTools(response.tool_calls);
  }
  
  return response;
}
```

---

## 6. 里程碑与验收标准

### 6.1 里程碑检查点

| 里程碑 | 预计完成 | 核心交付物 | 验收标准 |
|--------|----------|-----------|----------|
| **M1: 记忆基础** | Week 2 | 数据库 + CRUD API | 报价可存取，TTL 生效 |
| **M2: 记忆智能** | Week 4 | AI 集成记忆系统 | 对话自动调用/保存记忆 |
| **M3: 合规系统** | Week 6 | HS Code + 认证检查 | 输入产品输出风险等级 |
| **M4: 多市场** | Week 8 | Shopee/Lazada 数据 | 东南亚市场可查询 |
| **M5: CRM** | Week 10 | 客户管理 + 开发信 | AI 生成多语言邮件 |
| **M6: 自动化** | Week 12 | 监控 + 提醒 | 价格变化自动通知 |

### 6.2 核心功能验收场景

#### 场景 A: 智能报价记忆

```
用户: "德国海运报价多少？"

系统流程:
1. [Memory Service] 查询 quotes 表: route LIKE '%DE%', valid_until > NOW()
2. [AI] 返回: "根据记忆，A货代报价 $1500 (有效至下周)，B货代 $1700"
3. [Memory Agent] 如果用户提供新报价，自动保存

验收标准:
✅ 能查询到有效报价
✅ 过期报价不返回
✅ 新报价能保存
```

#### 场景 B: 法规知识更新

```
用户: "美国对电池有什么新规定？"

系统流程:
1. [Search-RAG] 调用 Tavily 搜索最新法规
2. [Memory Agent] 检测到新法规，调用 save_regulation
3. [AI] 整合搜索结果和知识库回答

验收标准:
✅ 实时搜索最新信息
✅ 自动保存到知识库
✅ 新旧版本正确管理
```

#### 场景 C: 供应链关联查询

```
用户: "找个能运危险品到德国的便宜货代"

系统流程:
1. [SQL] 查询 quotes: freight + CN-DE + 最低价
2. [Graph] 查询 entity_relations: has_certification = 'dangerous_goods'
3. [AI] 交叉过滤: A货代便宜但无资质，推荐B货代

验收标准:
✅ 价格排序正确
✅ 资质过滤生效
✅ 给出合理推荐
```

---

## 📎 附录

### A. 环境变量配置

```env
# 数据库
DATABASE_URL=postgresql://admin:password@localhost:5432/tradenexus

# AI 服务
OPENROUTER_API_KEY=sk-or-...
DEEPSEEK_API_KEY=sk-...
TAVILY_API_KEY=tvly-...

# 外部 API
RAPIDAPI_KEY=...

# 代理 (可选)
HTTPS_PROXY=http://127.0.0.1:7890
```

### B. 快速启动命令

```bash
# 1. 安装依赖
cd backend && npm install

# 2. 启动数据库 (Docker)
docker-compose up -d postgres redis

# 3. 安装 pgvector 扩展
psql -U admin -d tradenexus -c "CREATE EXTENSION IF NOT EXISTS vector;"

# 4. 执行迁移
npx prisma migrate dev

# 5. 启动后端
npm run start:dev

# 6. 启动前端
cd .. && npm run dev
```

### C. 相关文档

- [Titans 记忆系统详细设计](./TITANS_MEMORY_IMPLEMENTATION_PLAN.md)
- [v3.0 开发路线图](./DEVELOPMENT_ROADMAP_V3.md)
- [Sprint 追踪](./SPRINT_TRACKER.md)

---

*文档版本: v4.0*  
*最后更新: 2025-12-13*  
*状态: 已审核通过*
